/*****************************************************************************
Código: fact.c
Autor: Pedro Schimit
Data: 17/06/2013
Revisões
Data        Observações
17/06/13    Primeira versão
18/08/13    Adaptado para problemas não quadráticos - Flávio Grassi
*****************************************************************************/

/* includes */
#include "fact_LA2.h"
#include <stdio.h>
#include <stdlib.h>


//#define _DEBUG_FACT_

/* global variables */
int priority[MACHINE][JOB];
int tempo[JOB][MACHINE];
int sequence[SEQUENCE][MACHINE];

int machines[MACHINE];
int priomachines[MACHINE];

enum{
	START=0,
	END,
};

enum{
	NOPRIORITY=0,
	MACHPRIORITY,
};

struct sequence {
	int iStep;
	int iWaiting;
	int iWaitingFor;
	int itempo;
	int iMach;
	int isActive;
	int isDead;
	int iSequences;
};

struct sequence sSequence[SEQUENCE];

/* functions */

void carregadados();
void checkmachines(int tempostep, int iter, int iPrioMode);
void checkprocesses(int tempostep, int iter, int iPrioMode);

int factivel(int *vPriorities, int *vSequences, int iPrioMode){
// Matriz de tempos nos jobs, NA ORDEM DE MÁQUINAS DE ACORDO COM A MATRIZ DE ROTAS A SER PASSADA NO MAIN
// Problema JSSP 5x5 Mirshekarian (2016) Correlation of job-shop scheduling problem features.
//int JT[JOB][MACHINE]= {{96, 70, 6, 58, 86},{37, 26, 23, 14, 34},{21, 83, 29, 66, 25},{18, 73, 28, 29, 89},{87, 41, 32, 77, 77}};
//LA1
//int JT[JOB][MACHINE]={{21, 53, 95, 55, 34},{21, 52, 16, 26, 71},{39, 98, 42, 31, 12},{77, 55, 79, 66, 77},{83, 34, 64, 19, 37},{54, 43, 79, 92, 62},{69, 77, 87, 87, 93},{38, 60, 41, 24, 83},{17, 49, 25, 44, 98},{77, 79, 43, 75, 96}};
// LA2
int JT[JOB][MACHINE]= {{20, 87, 31, 76, 17},{25, 32, 24, 18, 81},{72, 23, 28, 58, 99},{86, 76, 97, 45, 90},{27, 42, 48, 17, 46},{67, 98, 48, 27, 62},{28, 12, 19, 80, 50},{63, 94, 98, 50, 80},{14, 75, 50, 41, 55},{72, 18, 37, 79, 61}};
//LA3
//int JT[JOB][MACHINE]={{23, 45, 82, 84, 38},{21, 29, 18, 41, 50},{38, 54, 16, 52, 52},{37, 54, 74, 62, 57},{57, 81, 61, 68, 30},{81, 79, 89, 89, 11},{33, 20, 91, 20, 66},{24, 84, 32, 55, 8},{56, 7, 54, 64, 39},{40, 83, 19, 8, 7}};
//LA4
//int JT[JOB][MACHINE]={{12, 94, 92, 91, 7},{19, 11, 66, 21, 87},{14, 75, 13, 16, 20},{95, 66, 7, 7, 77},{45, 6, 89, 15, 34},{77, 20, 76, 88, 53},{74, 88, 52, 27, 9},{88, 69, 62, 98, 52},{61, 9, 62, 52, 90},{54, 5, 59, 15, 88}};
//LA5
//int JT[JOB][MACHINE]={{72, 87, 95, 66, 60},{5, 35, 48, 39, 54},{46, 20, 21, 97, 55},{59, 19, 46, 34, 37},{23, 73, 25, 24, 28},{28, 45, 5, 78, 83},{53, 71, 37, 29, 12},{12, 87, 33, 55, 38},{49, 83, 40, 48, 7},{65, 17, 90, 27, 23}};
//LA6
//int JT[JOB][MACHINE]={{21, 34, 95, 53, 55},{52, 16, 71, 26, 21},{31, 12, 42, 39, 98},{77, 77, 79, 55, 66},{37, 34, 64, 19, 83},{43, 54, 92, 62, 79},{93, 69, 87, 77, 87},{60, 41, 38, 83, 24},{98, 17, 25, 44, 49},{96, 77, 79, 75, 43},{28, 35, 95, 76, 7},{61, 10, 95, 9, 35},{59, 16, 91, 59, 46},{43, 52, 28, 27, 50},{87, 45, 39, 9, 41}};
//LA7
//int JT[JOB][MACHINE]={{47, 57, 71, 96, 14},{75, 60, 22, 79, 65},{32, 33, 69, 31, 58},{44, 34, 51, 58, 47},{29, 44, 62, 17, 8},{15, 40, 97, 38, 66},{58, 39, 57, 20, 50},{57, 32, 87, 63, 21},{56, 84, 90, 85, 61},{15, 20, 67, 30, 70},{84, 82, 23, 45, 38},{50, 21, 18, 41, 29},{16, 52, 52, 38, 54},{37, 54, 57, 74, 62},{57, 61, 81, 30, 68}};
//LA8
//int JT[JOB][MACHINE]={{92, 94, 12, 91, 7},{21, 19, 87, 11, 66},{14, 13, 75, 16, 20},{95, 66, 7, 77, 7},{34, 89, 6, 45, 15},{88, 77, 20, 53, 76},{9, 27, 52, 88, 74},{69, 52, 62, 88, 98},{90, 62, 9, 61, 52},{5, 54, 59, 88, 15},{41, 50, 78, 53, 23},{38, 72, 91, 68, 71},{45, 95, 52, 25, 6},{30, 66, 23, 36, 17},{95, 71, 76, 8, 88}};
//LA09
//int JT[JOB][MACHINE]={{66, 85, 84, 62, 19},{59, 64, 46, 13, 25},{88, 80, 73, 53, 41},{14, 67, 57, 74, 47},{84, 64, 41, 84, 78},{63, 28, 46, 26, 52},{10, 17, 73, 11, 64},{67, 97, 95, 38, 85},{95, 46, 59, 65, 93},{43, 85, 32, 85, 60},{49, 41, 61, 66, 90},{17, 23, 70, 99, 49},{40, 73, 73, 98, 68},{57, 9, 7, 13, 98},{37, 85, 17, 79, 41}};
//LA10
//int JT[JOB][MACHINE]={{58, 44, 5, 9, 58},{89, 97, 96, 77, 84},{77, 87, 81, 39, 85},{57, 21, 31, 15, 73},{48, 40, 49, 70, 71},{34, 82, 80, 10, 22},{91, 75, 55, 17, 7},{62, 47, 72, 35, 11},{64, 75, 50, 90, 94},{67, 20, 15, 12, 71},{52, 93, 68, 29, 57},{70, 58, 93, 7, 77},{27, 82, 63, 6, 95},{87, 56, 36, 26, 48},{76, 36, 36, 15, 8}};
//LA11
//int JT[JOB][MACHINE]={{34, 21, 53, 55, 95},{21, 52, 71, 16, 26},{12, 42, 31, 98, 39},{66, 77, 79, 55, 77},{83, 37, 34, 19, 64},{79, 43, 92, 62, 54},{93, 77, 87, 87, 69},{83, 24, 41, 38, 60},{25, 49, 44, 98, 17},{96, 75, 43, 77, 79},{95, 76, 7, 28, 35},{10, 95, 61, 9, 35},{91, 59, 59, 46, 16},{27, 52, 43, 28, 50},{9, 87, 41, 39, 45},{54, 20, 43, 14, 71},{33, 28, 26, 78, 37},{89, 33, 8, 66, 42},{84, 69, 94, 74, 27},{81, 45, 78, 69, 96}};
//L16
//int JT[JOB][MACHINE]={{21, 71, 16, 52, 26, 34, 53, 21, 55, 95},{55, 31, 98, 79, 12, 66, 42, 77, 77, 39},{34, 64, 62, 19, 92, 79, 43, 54, 83, 37},{87, 69, 87, 38, 24, 83, 41, 93, 77, 60},{98, 44, 25, 75, 43, 49, 96, 77, 17, 79},{35, 76, 28, 10, 61, 9, 95, 35, 7, 95},{16, 59, 46, 91, 43, 50, 52, 59, 28, 27},{45, 87, 41, 20, 54, 43, 14, 9, 39, 71},{33, 37, 66, 33, 26, 8, 28, 89, 42, 78},{69, 81, 94, 96, 27, 69, 45, 78, 74, 84}};
//L17
//int JT[JOB][MACHINE]={{18, 21, 41, 45, 38, 50, 84, 29, 23, 82},{57, 16, 52, 74, 38, 54, 62, 37, 54, 52},{30, 79, 68, 61, 11, 89, 89, 81, 81, 57},{91, 8, 33, 55, 20, 20, 32, 84, 66, 24},{40, 7, 19, 7, 83, 64, 56, 54, 8, 39},{91, 64, 40, 63, 98, 74, 61, 6, 42, 15},{80, 39, 24, 75, 75, 6, 44, 26, 87, 22},{15, 43, 20, 12, 26, 61, 79, 22, 8, 80},{62, 96, 22, 5, 63, 33, 10, 18, 36, 40},{96, 89, 64, 95, 23, 18, 15, 64, 38, 8}};
//L18
//int JT[JOB][MACHINE]={{54, 87, 48, 60, 39, 35, 72, 95, 66, 5},{20, 46, 34, 55, 97, 19, 59, 21, 37, 46},{45, 24, 28, 28, 83, 78, 23, 25, 5, 73},{12, 37, 38, 71, 33, 12, 55, 53, 87, 29},{83, 49, 23, 27, 65, 48, 90, 7, 40, 17},{66, 25, 62, 84, 13, 64, 46, 59, 19, 85},{73, 80, 41, 53, 47, 57, 74, 14, 67, 88},{64, 84, 46, 78, 84, 26, 28, 52, 41, 63},{11, 64, 67, 85, 10, 73, 38, 95, 97, 17},{60, 32, 95, 93, 65, 85, 43, 85, 46, 59}};
//L19
//int JT[JOB][MACHINE]={{44, 5, 58, 97, 9, 84, 77, 96, 58, 89},{15, 31, 87, 57, 77, 85, 81, 39, 73, 21},{82, 22, 10, 70, 49, 40, 34, 48, 80, 71},{91, 17, 62, 75, 47, 11, 7, 72, 35, 55},{71, 90, 75, 64, 94, 15, 12, 67, 20, 50},{70, 93, 77, 29, 58, 93, 68, 57, 7, 52},{87, 63, 26, 6, 82, 27, 56, 48, 36, 95},{36, 15, 41, 78, 76, 84, 30, 76, 36, 8},{88, 81, 13, 82, 54, 13, 29, 40, 78, 75},{88, 54, 64, 32, 52, 6, 54, 82, 6, 26}};
//L20
//int JT[JOB][MACHINE]={{9, 81, 55, 40, 32, 37, 6, 19, 81, 40},{21, 70, 65, 64, 46, 65, 25, 77, 55, 15},{85, 37, 40, 24, 44, 83, 89, 31, 84, 29},{80, 77, 56, 8, 30, 59, 38, 80, 41, 97},{91, 40, 88, 17, 71, 50, 59, 80, 56, 7},{8, 9, 58, 77, 29, 96, 45, 10, 54, 36},{70, 92, 98, 87, 99, 27, 86, 96, 28, 73},{95, 92, 85, 52, 81, 32, 39, 59, 41, 56},{60, 45, 88, 12, 7, 22, 93, 49, 69, 27},{21, 61, 68, 26, 82, 71, 44, 99, 33, 84}};
// LA22
//int JT[JOB][MACHINE]={{66, 91, 87, 94, 21, 92, 7, 12, 11, 19},{13, 20, 7, 14, 66, 75, 77, 16, 95, 7},{77, 20, 34, 15, 88, 89, 53, 6, 45, 76},{27, 74, 88, 62, 52, 69, 9, 98, 52, 88},{88, 15, 52, 61, 54, 62, 59, 9, 90, 5},{71, 41, 38, 53, 91, 68, 50, 78, 23, 72},{95, 36, 66, 52, 45, 30, 23, 25, 17, 6},{65, 8, 85, 71, 65, 28, 88, 76, 27, 95},{37, 37, 28, 51, 86, 9, 55, 73, 51, 90},{39, 15, 83, 44, 53, 16, 46, 24, 25, 82},{72, 48, 87, 66, 5, 54, 39, 35, 95, 60},{46, 20, 97, 21, 46, 37, 19, 59, 34, 55},{23, 25, 78, 24, 28, 83, 28, 5, 73, 45},{37, 53, 87, 38, 71, 29, 12, 33, 55, 12},{90, 17, 49, 83, 40, 23, 65, 27, 7, 48}};

///FT06
//int JT[JOB][MACHINE]={{1,	3,	6,	7,	3,	6}, {8,	5,	10,	10,	10,	4}, {5,	4,	8,	9,	1,	7}, {5,	5,	5,	3,	8,	9}, {9,	3,	5,	4,	3,	1}, {3,	3,	9,	10,	4,	1}};
///FT10
/*int JT[JOB][MACHINE] = {{29,	78,	9,	36,	49,	11,	62,	56,	44,	21},
                        {43,	90,	75,	11,	69,	28,	46,	46,	72,	30},
                        {91,	85,	39,	74,	90,	10,	12,	89,	45,	33},
                        {81,	95,	71,	99,	9,  52,	85,	98,	22,	43},
                        {14,	6,	22,	61,	26,	69,	21,	49,	72,	53},
                        {84,	2,	52,	95,	48,	72,	47,	65,	6,	25},
                        {46,	37,	61,	13,	32,	21,	32,	89,	30,	55},
                        {31,	86,	46,	74,	32,	88,	19,	48,	36,	79},
                        {76,	69,	76,	51,	85,	11,	40,	89,	26,	74},
                      {85,	13,	61,	7,  64,	76,	47,	52,	90,	45}};*/

///FT20
/*int JT[JOB][MACHINE] = {{29, 9, 49, 62, 44}, {43, 75, 69, 46, 72}, {91, 39, 90, 12, 45}, {81, 71, 9, 85, 22}, {14, 22, 26, 21, 72}, {84, 52, 48, 47, 6},
                        {46, 61, 32, 32, 30}, {31, 46, 32, 19, 36}, {76, 76, 85, 40, 26}, {85, 61, 64, 47, 90}, {78, 36, 11, 56, 21}, {90, 11, 28, 46, 30},
                        {85, 74, 10, 89, 33}, {95, 99, 52, 98, 43}, {6, 61, 69, 49, 53}, {2, 95, 72, 65, 25}, {37, 13, 21, 89, 55}, {86, 74, 88, 48, 79}, {69, 51, 11, 89, 74},
                        {13, 7, 76, 52, 45}};*/
///orb01
/*int JT[JOB][MACHINE] = {{72,64,55,31,53,95,11,52,6,84}, {61,27,88,78,49,83,91,74,29,87}, {86,32,35,37,18,48,91,52,60,30},
{8,82,27,99,74,9,33,20,59,98}, {50,94,43,62,55,48,5,36,47,36}, {53,30,7,12,68,87,28,70,45,7}, {29,96,99,14,34,14,7,76,57,76},
{90,19,87,51,84,45,84,58,81,96}, {97,99,93,38,13,96,40,64,32,45}, {44,60,29,5,74,85,34,95,51,47}};
*/
///orb02
/*
int JT[JOB][MACHINE] = {{72,54,33,86,75,16,96,7,99,76},
{16,88,48,52,60,29,18,89,80,76},
{47,11,14,56,16,83,10,61,24,58},
{49,31,17,50,63,35,65,23,50,29},
{55,6,28,96,86,99,14,70,64,24},
{46,23,70,19,54,22,85,87,79,93},
{76,60,76,98,76,50,86,14,27,57},
{93,27,57,87,86,54,24,49,20,47},
{28,11,78,85,63,81,10,9,46,32},
{22,76,89,13,88,10,75,98,78,17}};
*/

///orb03
/*
int JT[JOB][MACHINE] = {{96,69,25,5,55,15,88,11,17,82},
{11,48,67,38,18,24,62,92,96,81},
{67,63,93,85,25,72,51,81,58,15},
{30,35,27,82,44,92,25,49,28,77},
{53,83,73,26,77,33,92,99,38,38},
{20,44,81,88,66,70,91,37,55,96},
{21,93,22,56,34,40,53,46,29,63},
{32,63,36,26,17,85,15,55,16,82},
{73,46,89,24,99,92,7,51,19,14},
{52,20,70,98,23,15,81,71,24,81}};
*/
    int i,j,k;
	int iter, mach;

    for(i=0;i<JOB;i++)
        for(j=0;j<MACHINE;j++)
            tempo[i][j] = JT[i][j];

    for(i=0;i<MACHINE;i++)
        for(j=0;j<JOB;j++)
			priority[i][j] = vPriorities[i*JOB+j];

    for(i=0;i<SEQUENCE;i++)
		for(j=0;j<MACHINE;j++)
			sequence[i][j]=vSequences[i*MACHINE+j];


#ifdef _DEBUG_FACT_
	printf("\n tempos\n");
	for(i=0;i<JOB;i++){
		for(j=0;j<MACHINE;j++)1 6 8 5 2 9 7 3 4 10 6 8 3 10 1 4 7 2 5 9 4 2 10 3 6 8 5 1 9 7 1 6 10 5 7 2 8 9 3 4 2 10 5 9 6 3 7 1 4 8

			printf("%d\t", tempo[i][j]);
		printf("\n");
	}

	printf("\n\n Priorities\n");
	for(i=0;i<MACHINE;i++){
		for(j=0;j<JOB;j++)
			printf("%d\t", priority[i][j]);
		printf("\n");
	}

	printf("\n\n Sequences\n");
	for(i=0;i<SEQUENCE;i++){
		for(j=0;j<MACHINE;j++)
			printf("%d\t", sequence[i][j]);
		printf("\n");
	}
#endif //_DEBUG_FACT_

	for(i=0;i<MACHINE;i++){
		machines[i]=0;
		priomachines[i]=1;
	}

	for(i=0;i<SEQUENCE;i++){
		sSequence[i].itempo = 0;
		sSequence[i].iStep = 0;
		sSequence[i].iWaiting = 1;
		sSequence[i].iWaitingFor = sequence[i][sSequence[i].iStep]-1;
		sSequence[i].isActive = 0;
		sSequence[i].isDead = 0;
		sSequence[i].iSequences = MACHINE;
	}

	for(iter=0;iter<ITER;iter++){

		checkmachines(START, iter, iPrioMode);
		checkprocesses(START, iter, iPrioMode);
		checkmachines(END, iter, iPrioMode);
		checkprocesses(END, iter, iPrioMode);
      j=0;
      for(i=0;i<SEQUENCE;i++)
         if(!sSequence[i].isDead) j=1;
	   if(!j) break;
	}

	if(iter==ITER) return iter;
	else return iter+1;

}

void checkmachines(int tempostep, int iter, int iPrioMode){

	int i, j;

	for(i=0;i<MACHINE;i++){

		if(iPrioMode==NOPRIORITY){
			if(!machines[i]){
				for(j=0;j<SEQUENCE;j++){
					if(!machines[i] && sSequence[j].isActive==0
						&& sSequence[j].iWaitingFor==i && !sSequence[j].isDead){
						sSequence[j].itempo = 0;
						sSequence[j].iMach = i;
						sSequence[j].isActive = 1;
#ifdef _DEBUG_FACT_
						printf("\n Sequence %d started in machine %d at %d", j+1, i+1, iter);
#endif //_DEBUG_FACT_
						machines[i]=1;
					}
				}
			}
		}

		if(iPrioMode==MACHPRIORITY){
			if(!machines[i]){
				for(j=0;j<JOB;j++) if(priority[i][j]==priomachines[i]) break;

				if(!machines[i] && sSequence[j].isActive==0
					&& sSequence[j].iWaitingFor==i && !sSequence[j].isDead){

					priomachines[i]=priomachines[i]+1;
					sSequence[j].itempo = 0;
					sSequence[j].iMach = i;
					sSequence[j].isActive = 1;
#ifdef _DEBUG_FACT_
					printf("\n Sequence %d started in machine %d at %d", j+1, i+1, iter);
#endif //_DEBUG_FACT_
					machines[i]=1;
				}

			}
		}

	}
}

void checkprocesses(int tempostep, int iter, int iPrioMode){

	int i, j, x, y;

	for(j=0;j<SEQUENCE;j++){
		if(sSequence[j].isActive){
			if(sSequence[j].itempo>=tempo[j][sSequence[j].iStep]){
				sSequence[j].isActive=0;
#ifdef _DEBUG_FACT_
				printf("\n Sequence %d finished in machine %d at %d", j+1, sSequence[j].iMach+1, iter+1);
#endif //_DEBUG_FACT_
				sSequence[j].iStep++;
				sSequence[j].iWaiting=1;
				sSequence[j].iWaitingFor=sequence[j][sSequence[j].iStep]-1;
#ifdef _DEBUG_FACT_
            printf("\n Sequence %d is at step %d waiting for %d", j+1, sSequence[j].iStep, sequence[j][sSequence[j].iStep]);
#endif //_DEBUG_FACT_
				machines[sSequence[j].iMach]=0;
				//}
			}
			if(sSequence[j].iStep>=sSequence[j].iSequences){
				sSequence[j].isDead=1;
#ifdef _DEBUG_FACT_
				printf("\n Sequence %d is dead", j+1);
#endif //_DEBUG_FACT_
				machines[sSequence[j].iMach]=0;
			}
			if(tempostep==START)
				sSequence[j].itempo++;

		}
	}

}
